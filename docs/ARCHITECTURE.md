# Architecture Documentation

## Обзор системы

Stub Manager - это система управления динамическими заглушками с поддержкой тестирования отказоустойчивости.

## Компоненты

### Backend (NestJS)

Основной компонент системы, реализующий бизнес-логику и API.

#### Модули:

1. **Mocks Module**
   - Управление заглушками
   - CRUD операции
   - Управление статусом (start/stop)

2. **Routes Module**
   - Управление роутами заглушек
   - Настройка путей и методов

3. **Conditions Module**
   - Управление условиями для роутов
   - Определение ответов в зависимости от параметров запроса

4. **Scenarios Module**
   - Создание и управление сценариями тестирования
   - Планирование действий

5. **Executor Module**
   - Выполнение сценариев тестирования
   - Управление жизненным циклом заглушек

6. **Generator Module**
   - Генерация кода заглушек
   - Поддержка различных протоколов (REST, gRPC, Kafka)

7. **Cache Module**
   - Реализация Dead Cache
   - Работа при потере связи с БД

### Runtime

Среда выполнения для динамических заглушек.

#### Компоненты:

- **REST Protocol Handler** - обработка REST запросов
- **gRPC Protocol Handler** - обработка gRPC запросов (в разработке)
- **Kafka Handler** - обработка Kafka сообщений (в разработке)
- **Parameter Extractor** - извлечение параметров из запросов
- **Condition Evaluator** - оценка условий
- **Response Builder** - построение ответов

### Frontend

Веб-интерфейс для управления системой.

#### Страницы:

- Управление заглушками
- Управление роутами
- Управление условиями
- Сценарии тестирования

### Database (PostgreSQL)

Хранилище данных системы.

#### Таблицы:

- `mocks` - заглушки
- `routes` - роуты заглушек
- `conditions` - условия для роутов
- `responses` - ответы для условий
- `scenarios` - сценарии тестирования
- `scenario_actions` - действия сценариев
- `scenario_executions` - результаты выполнения сценариев

### Cache (Redis)

Кэш для реализации Dead Cache.

- TTL по умолчанию: 1 час
- Поддержка работы при потере связи с БД

## Архитектурные паттерны

### Модульная архитектура

Система разделена на независимые модули, каждый из которых отвечает за свою область функциональности.

### Repository Pattern

Доступ к данным осуществляется через репозитории TypeORM.

### Service Layer

Бизнес-логика инкапсулирована в сервисы.

### DTO Pattern

Передача данных между слоями осуществляется через DTO объекты.

## Потоки данных

### Создание заглушки

1. Пользователь создает заглушку через UI
2. Frontend отправляет запрос на Backend API
3. Backend сохраняет заглушку в БД
4. Backend кэширует данные в Redis
5. Backend возвращает результат

### Выполнение сценария

1. Пользователь запускает сценарий
2. Backend создает execution record
3. Executor Service выполняет действия по расписанию
4. Каждое действие обновляет состояние заглушек
5. Результаты сохраняются в БД

### Dead Cache

1. При запросе данных сначала проверяется кэш
2. Если данных нет в кэше, выполняется запрос к БД
3. Полученные данные кэшируются с TTL 1 час
4. При ошибке БД возвращаются данные из кэша

## Масштабирование

- Backend: горизонтальное масштабирование (несколько реплик)
- Runtime: независимые инстансы для каждой заглушки
- Database: репликация для чтения
- Cache: Redis Cluster для высокой доступности

## Безопасность

- Валидация входных данных (class-validator)
- Защита от SQL инъекций (TypeORM)
- CORS настройка
- Rate limiting (в разработке)
