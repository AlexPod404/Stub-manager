# User Guide

## Введение

Stub Manager - это система для управления динамическими заглушками (mocks/stubs) с поддержкой тестирования отказоустойчивости.

## Основные концепции

### Заглушки (Mocks)

Заглушка - это имитация внешнего сервиса, которая позволяет тестировать приложение без зависимости от реальных сервисов.

### Роуты (Routes)

Роут определяет конкретный путь и метод, на который будет отвечать заглушка.

### Условия (Conditions)

Условия позволяют возвращать разные ответы в зависимости от параметров запроса.

### Сценарии (Scenarios)

Сценарии позволяют автоматизировать тестирование отказоустойчивости, управляя заглушками по расписанию.

## Быстрый старт

### 1. Создание заглушки

1. Откройте веб-интерфейс
2. Перейдите в раздел "Заглушки"
3. Нажмите "Создать заглушку"
4. Заполните форму:
   - Название: User Service
   - Описание: Заглушка для сервиса пользователей
   - Протокол: REST
5. Нажмите "Сохранить"

### 2. Создание роута

1. Откройте созданную заглушку
2. Перейдите во вкладку "Роуты"
3. Нажмите "Добавить роут"
4. Заполните форму:
   - Путь: /api/users/:id
   - Метод: GET
   - Задержка: 0 мс
5. Нажмите "Сохранить"

### 3. Добавление условия

1. Откройте созданный роут
2. Нажмите "Добавить условие"
3. Заполните форму:
   - Тип: equals
   - Параметр: id
   - Источник: path
   - Значение: 123
   - Ответ:
     ```json
     {
       "statusCode": 200,
       "body": {
         "id": "123",
         "name": "John Doe",
         "email": "john@example.com"
       }
     }
     ```
4. Нажмите "Сохранить"

### 4. Запуск заглушки

1. Вернитесь к списку заглушек
2. Найдите созданную заглушку
3. Нажмите кнопку "Запустить"
4. Заглушка станет активной

### 5. Тестирование

Отправьте запрос к заглушке:

```bash
curl http://localhost:3001/api/users/123
```

Ответ:
```json
{
  "id": "123",
  "name": "John Doe",
  "email": "john@example.com"
}
```

## Работа с условиями

### Типы условий

#### Equals (Равенство)
Проверяет точное совпадение значения.

```json
{
  "type": "equals",
  "parameterName": "status",
  "parameterSource": "query",
  "value": "active"
}
```

#### Contains (Содержит)
Проверяет, содержит ли значение подстроку.

```json
{
  "type": "contains",
  "parameterName": "email",
  "parameterSource": "body",
  "parameterPath": "user.email",
  "value": "@example.com"
}
```

#### Regex (Регулярное выражение)
Проверяет значение с помощью регулярного выражения.

```json
{
  "type": "regex",
  "parameterName": "phone",
  "parameterSource": "body",
  "value": "^\\+7\\d{10}$"
}
```

### Источники параметров

- **header** - HTTP заголовок
- **query** - Query параметр URL
- **body** - Тело запроса
- **path** - Параметр пути

### Приоритет условий

Условия проверяются в порядке убывания приоритета. Первое совпавшее условие определяет ответ.

## Создание сценариев

### Пример сценария тестирования

Создадим сценарий, который:
1. Запускает заглушку
2. Через 5 секунд устанавливает задержку 2 секунды
3. Через 10 секунд останавливает заглушку

```json
{
  "name": "Latency Test",
  "description": "Тест увеличения задержки",
  "actions": [
    {
      "order": 1,
      "timeOffsetMs": 0,
      "actionType": "start",
      "targetMockId": "mock-uuid"
    },
    {
      "order": 2,
      "timeOffsetMs": 5000,
      "actionType": "set_delay",
      "targetMockId": "mock-uuid",
      "params": { "delayMs": 2000 }
    },
    {
      "order": 3,
      "timeOffsetMs": 10000,
      "actionType": "stop",
      "targetMockId": "mock-uuid"
    }
  ]
}
```

### Запуск сценария

1. Откройте раздел "Сценарии"
2. Найдите нужный сценарий
3. Нажмите "Выполнить"
4. Наблюдайте за выполнением в реальном времени

### Просмотр результатов

1. После завершения сценария нажмите "Результаты"
2. Просмотрите детали выполнения каждого действия

## Управление задержками

### Установка задержки для заглушки

Это установит задержку для всех роутов заглушки:

```bash
curl -X PUT http://localhost:3000/api/mocks/{mockId}/delay \
  -H "Content-Type: application/json" \
  -d '{"delayMs": 1000}'
```

### Установка задержки для роута

```json
{
  "delayMs": 500
}
```

## Dead Cache

При потере связи с БД система продолжит работать в течение 1 часа, используя данные из кэша Redis.

### Проверка работы Dead Cache

1. Остановите PostgreSQL
2. Система продолжит работать с закэшированными данными
3. Через 1 час данные устареют

## Протоколы

### REST

Полностью поддерживается.

### gRPC

В разработке.

### Kafka

В разработке.

## Best Practices

### 1. Именование заглушек

Используйте понятные имена, отражающие назначение:
- ✅ `User Service API`
- ✅ `Payment Gateway Mock`
- ❌ `Mock1`, `Test`

### 2. Организация условий

Используйте приоритеты для правильного порядка проверки:
- Более специфичные условия - выше приоритет
- Общие условия - ниже приоритет
- Default ответ - приоритет 0

### 3. Тестирование

Всегда тестируйте заглушки перед использованием в сценариях.

### 4. Документирование

Добавляйте описания к заглушкам, роутам и сценариям.

## Troubleshooting

### Заглушка не отвечает

1. Проверьте статус заглушки (должна быть ACTIVE)
2. Проверьте конфигурацию роутов
3. Проверьте логи Runtime

### Условие не срабатывает

1. Проверьте тип условия
2. Проверьте источник параметра
3. Проверьте приоритет условия

### Сценарий не выполняется

1. Проверьте статус выполнения
2. Проверьте логи Executor Service
3. Проверьте корректность действий сценария
